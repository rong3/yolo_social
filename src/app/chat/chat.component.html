<div #spinnerElement>
    <app-loading></app-loading>
</div>

<div class=" chat">
    <div class="card">
        <div class="card-header msg_head">
            <!-- <div class="d-flex bd-highlight">
                <div class="img_cont">
                    <img [src]="'assets/avatar/girl.png'" class="rounded-circle user_img">
                </div>
                <div class="user_info">
                    <span>Bot Sales</span>
                </div>
                <div class="video_cam" style="display: none;">
                    <span><i style="color:black !important;" class="fas fa-video"></i></span>
                    <span></span>
                    <span><i style="color:black !important;" class="fas fa-phone"></i></span>
                </div>
            </div> -->
            <span id="action_menu_btn"><i class="fas fa-ellipsis-v"></i></span>
            <div class="action_menu">
                <ul>
                    <li><i class="fas fa-user-circle"></i> Mua ly nước cho admin :)</li>
                    <!-- <li><i class="fas fa-plus"></i> Add to group</li> -->
                    <li (click)="clearHistory()" id='clearHistory'><i class="fas fa-ban"></i> Xóa lịch sử chat (cls)</li>
                    <!-- <li (click)="navigates()"><i class="fas fa-users"></i>Khu rao bán</li> -->

                </ul>
            </div>
        </div>
        <div id="scrollcustom" class="card-body msg_card_body">

            <ng-container *ngFor="let message of messages | async">

                <div class="message" [ngClass]="{'d-flex flex-row justify-content-start mb-1': message.sentBy==='bot',
                        'd-flex flex-row justify-content-end mb-1': message.sentBy==='user'      
                          }">
                    <div [ngClass]="{'msg_cotainer inline': message.sentBy==='bot',
                          'msg_cotainer_send inline': message.sentBy==='user'      
                            }">

                        <div *ngIf="(message.content.indexOf('http') === -1)
                             then normalBlock; else multiMediaBlock"> </div>

                        <ng-template #normalBlock>
                            <ng-container *ngIf="message.payLoad.length < 2;else buttonBlock">
                                <div [innerHTML]="message.content | safeHtml"> </div>
                            </ng-container>
                        </ng-template>

                        <ng-template #buttonBlock>
                            <div [innerHTML]="message.content | safeHtml"> </div>
                            <hr>
                            <div class="btn-group-horizontal" role="toolbar" aria-label="Toolbar with button groups">

                                <ng-container *ngFor="let btnElement of message.payLoad[1].payload.button">
                                    <app-message-button [model]="btnElement"> </app-message-button>
                                </ng-container>

                            </div>
                        </ng-template>

                        <ng-template #multiMediaBlock>

                            <ng-container [ngSwitch]="true" *ngFor="let multiMedia of message.content.split(';')">

                                <template class="d-inline-block">
                                        
                                    <ng-container *ngSwitchCase="multiMedia.indexOf('<html>') !== -1;">
                                        <div [innerHTML]="message.content | safeHtml"> </div>
                                    </ng-container>

                                        <ng-container *ngSwitchCase="message.payLoad.length > 1;">
                                            <app-multi-media-block [model]="message.payLoad[getRandomArbitrary(2,message.payLoad.length -1 )].payload.products"></app-multi-media-block>
                                        </ng-container>
                                     
                                        <ng-container *ngSwitchCase="multiMedia.indexOf('<html>') === -1 && (multiMedia.indexOf('.jpg') !== -1 || multiMedia.indexOf('.jpeg') !== -1 || multiMedia.indexOf('.png') !== -1 || multiMedia.indexOf('.svg') !== -1);">
                                      
                                            <div class="card-body pt-3 pt-sm-0 pt-md-3 pt-lg-0">
                                                <div class="card-text mb-2 text-muted small">
                                                   
                                                    <a [href]=multiMedia target="_blank">
                                                        <img [src]=multiMedia width="229" height="200" 
                                                        style="padding-left: 3px; padding-top: 3px; border-radius: 10px;" alt="img" 
                                                        onError="this.src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/Pgo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9HcmFwaGljcy9TVkcvMS4xL0RURC9zdmcxMS5kdGQiPgo8c3ZnIHdpZHRoPSI0MHB4IiBoZWlnaHQ9IjQwcHgiIHZpZXdCb3g9IjAgMCA0MCA0MCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4bWw6c3BhY2U9InByZXNlcnZlIiBzdHlsZT0iZmlsbC1ydWxlOmV2ZW5vZGQ7Y2xpcC1ydWxlOmV2ZW5vZGQ7c3Ryb2tlLWxpbmVqb2luOnJvdW5kO3N0cm9rZS1taXRlcmxpbWl0OjEuNDE0MjE7IiB4PSIwcHgiIHk9IjBweCI+CiAgICA8ZGVmcz4KICAgICAgICA8c3R5bGUgdHlwZT0idGV4dC9jc3MiPjwhW0NEQVRBWwogICAgICAgICAgICBALXdlYmtpdC1rZXlmcmFtZXMgc3BpbiB7CiAgICAgICAgICAgICAgZnJvbSB7CiAgICAgICAgICAgICAgICAtd2Via2l0LXRyYW5zZm9ybTogcm90YXRlKDBkZWcpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRvIHsKICAgICAgICAgICAgICAgIC13ZWJraXQtdHJhbnNmb3JtOiByb3RhdGUoLTM1OWRlZykKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgQGtleWZyYW1lcyBzcGluIHsKICAgICAgICAgICAgICBmcm9tIHsKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDBkZWcpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHRvIHsKICAgICAgICAgICAgICAgIHRyYW5zZm9ybTogcm90YXRlKC0zNTlkZWcpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHN2ZyB7CiAgICAgICAgICAgICAgICAtd2Via2l0LXRyYW5zZm9ybS1vcmlnaW46IDUwJSA1MCU7CiAgICAgICAgICAgICAgICAtd2Via2l0LWFuaW1hdGlvbjogc3BpbiAxLjVzIGxpbmVhciBpbmZpbml0ZTsKICAgICAgICAgICAgICAgIC13ZWJraXQtYmFja2ZhY2UtdmlzaWJpbGl0eTogaGlkZGVuOwogICAgICAgICAgICAgICAgYW5pbWF0aW9uOiBzcGluIDEuNXMgbGluZWFyIGluZmluaXRlOwogICAgICAgICAgICB9CiAgICAgICAgXV0+PC9zdHlsZT4KICAgIDwvZGVmcz4KICAgIDxnIGlkPSJvdXRlciI+CiAgICAgICAgPGc+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yMCwwQzIyLjIwNTgsMCAyMy45OTM5LDEuNzg4MTMgMjMuOTkzOSwzLjk5MzlDMjMuOTkzOSw2LjE5OTY4IDIyLjIwNTgsNy45ODc4MSAyMCw3Ljk4NzgxQzE3Ljc5NDIsNy45ODc4MSAxNi4wMDYxLDYuMTk5NjggMTYuMDA2MSwzLjk5MzlDMTYuMDA2MSwxLjc4ODEzIDE3Ljc5NDIsMCAyMCwwWiIgc3R5bGU9ImZpbGw6YmxhY2s7Ii8+CiAgICAgICAgPC9nPgogICAgICAgIDxnPgogICAgICAgICAgICA8cGF0aCBkPSJNNS44NTc4Niw1Ljg1Nzg2QzcuNDE3NTgsNC4yOTgxNSA5Ljk0NjM4LDQuMjk4MTUgMTEuNTA2MSw1Ljg1Nzg2QzEzLjA2NTgsNy40MTc1OCAxMy4wNjU4LDkuOTQ2MzggMTEuNTA2MSwxMS41MDYxQzkuOTQ2MzgsMTMuMDY1OCA3LjQxNzU4LDEzLjA2NTggNS44NTc4NiwxMS41MDYxQzQuMjk4MTUsOS45NDYzOCA0LjI5ODE1LDcuNDE3NTggNS44NTc4Niw1Ljg1Nzg2WiIgc3R5bGU9ImZpbGw6cmdiKDIxMCwyMTAsMjEwKTsiLz4KICAgICAgICA8L2c+CiAgICAgICAgPGc+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yMCwzMi4wMTIyQzIyLjIwNTgsMzIuMDEyMiAyMy45OTM5LDMzLjgwMDMgMjMuOTkzOSwzNi4wMDYxQzIzLjk5MzksMzguMjExOSAyMi4yMDU4LDQwIDIwLDQwQzE3Ljc5NDIsNDAgMTYuMDA2MSwzOC4yMTE5IDE2LjAwNjEsMzYuMDA2MUMxNi4wMDYxLDMzLjgwMDMgMTcuNzk0MiwzMi4wMTIyIDIwLDMyLjAxMjJaIiBzdHlsZT0iZmlsbDpyZ2IoMTMwLDEzMCwxMzApOyIvPgogICAgICAgIDwvZz4KICAgICAgICA8Zz4KICAgICAgICAgICAgPHBhdGggZD0iTTI4LjQ5MzksMjguNDkzOUMzMC4wNTM2LDI2LjkzNDIgMzIuNTgyNCwyNi45MzQyIDM0LjE0MjEsMjguNDkzOUMzNS43MDE5LDMwLjA1MzYgMzUuNzAxOSwzMi41ODI0IDM0LjE0MjEsMzQuMTQyMUMzMi41ODI0LDM1LjcwMTkgMzAuMDUzNiwzNS43MDE5IDI4LjQ5MzksMzQuMTQyMUMyNi45MzQyLDMyLjU4MjQgMjYuOTM0MiwzMC4wNTM2IDI4LjQ5MzksMjguNDkzOVoiIHN0eWxlPSJmaWxsOnJnYigxMDEsMTAxLDEwMSk7Ii8+CiAgICAgICAgPC9nPgogICAgICAgIDxnPgogICAgICAgICAgICA8cGF0aCBkPSJNMy45OTM5LDE2LjAwNjFDNi4xOTk2OCwxNi4wMDYxIDcuOTg3ODEsMTcuNzk0MiA3Ljk4NzgxLDIwQzcuOTg3ODEsMjIuMjA1OCA2LjE5OTY4LDIzLjk5MzkgMy45OTM5LDIzLjk5MzlDMS43ODgxMywyMy45OTM5IDAsMjIuMjA1OCAwLDIwQzAsMTcuNzk0MiAxLjc4ODEzLDE2LjAwNjEgMy45OTM5LDE2LjAwNjFaIiBzdHlsZT0iZmlsbDpyZ2IoMTg3LDE4NywxODcpOyIvPgogICAgICAgIDwvZz4KICAgICAgICA8Zz4KICAgICAgICAgICAgPHBhdGggZD0iTTUuODU3ODYsMjguNDkzOUM3LjQxNzU4LDI2LjkzNDIgOS45NDYzOCwyNi45MzQyIDExLjUwNjEsMjguNDkzOUMxMy4wNjU4LDMwLjA1MzYgMTMuMDY1OCwzMi41ODI0IDExLjUwNjEsMzQuMTQyMUM5Ljk0NjM4LDM1LjcwMTkgNy40MTc1OCwzNS43MDE5IDUuODU3ODYsMzQuMTQyMUM0LjI5ODE1LDMyLjU4MjQgNC4yOTgxNSwzMC4wNTM2IDUuODU3ODYsMjguNDkzOVoiIHN0eWxlPSJmaWxsOnJnYigxNjQsMTY0LDE2NCk7Ii8+CiAgICAgICAgPC9nPgogICAgICAgIDxnPgogICAgICAgICAgICA8cGF0aCBkPSJNMzYuMDA2MSwxNi4wMDYxQzM4LjIxMTksMTYuMDA2MSA0MCwxNy43OTQyIDQwLDIwQzQwLDIyLjIwNTggMzguMjExOSwyMy45OTM5IDM2LjAwNjEsMjMuOTkzOUMzMy44MDAzLDIzLjk5MzkgMzIuMDEyMiwyMi4yMDU4IDMyLjAxMjIsMjBDMzIuMDEyMiwxNy43OTQyIDMzLjgwMDMsMTYuMDA2MSAzNi4wMDYxLDE2LjAwNjFaIiBzdHlsZT0iZmlsbDpyZ2IoNzQsNzQsNzQpOyIvPgogICAgICAgIDwvZz4KICAgICAgICA8Zz4KICAgICAgICAgICAgPHBhdGggZD0iTTI4LjQ5MzksNS44NTc4NkMzMC4wNTM2LDQuMjk4MTUgMzIuNTgyNCw0LjI5ODE1IDM0LjE0MjEsNS44NTc4NkMzNS43MDE5LDcuNDE3NTggMzUuNzAxOSw5Ljk0NjM4IDM0LjE0MjEsMTEuNTA2MUMzMi41ODI0LDEzLjA2NTggMzAuMDUzNiwxMy4wNjU4IDI4LjQ5MzksMTEuNTA2MUMyNi45MzQyLDkuOTQ2MzggMjYuOTM0Miw3LjQxNzU4IDI4LjQ5MzksNS44NTc4NloiIHN0eWxlPSJmaWxsOnJnYig1MCw1MCw1MCk7Ii8+CiAgICAgICAgPC9nPgogICAgPC9nPgo8L3N2Zz4K'"
                                                        />
                                                    </a>
                                                </div>
                                            </div>
                                             
                                          </ng-container>

                                      <ng-container *ngSwitchCase="multiMedia.indexOf('.mp4') !== -1;">
                                        <video width="229" height="200" style="padding-left: 3px; padding-top: 3px; border-radius: 10px;" controls>
                                            <source [src]="multiMedia" type="video/mp4">
                                            Your browser does not support the video tag.
                                          </video>
                                      </ng-container>

                                      <ng-container *ngSwitchCase="multiMedia.indexOf('youtube.com') !== -1;">
                                        <iframe [src]="multiMedia.replace('watch?v=','embed/') | safe" width="229" height="200" style="padding-left: 3px; padding-top: 3px; border-radius: 10px;" frameborder="0" allowfullscreen>
                                        </iframe>
                                      </ng-container>

                                      <ng-container *ngSwitchDefault>
                                        <a  [href]=multiMedia target="_blank">
                                            {{multiMedia}}
                                        </a>
                                        </ng-container>

                                    </template >

                                </ng-container>
                              
                                <div *ngIf="message.payLoad.length > 1;">
                                    <hr/>
                                    <ng-container *ngFor="let btnElement of message.payLoad[1].payload.button">
                                        <app-message-button [model]="btnElement"></app-message-button>
                                    </ng-container>
                                </div>
                            </ng-template>
                        </div>

                        <div [ngClass]="{'img_bot_cont_msg': message.sentBy==='bot',
                        'img_cont_msg': message.sentBy==='user'      
                          }">
                            <img sizes="40px"  [src]=" message.sentBy==='bot'? 'assets/avatar/girl.png'
                         :
                          'assets/avatar/user.png'" class="rounded-circle user_img_msg">

                        </div>
                    </div>
                </ng-container>
            </div>

            <div class="input-group small">
                <div class="input-group-append">
                    <span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
                </div>
                <textarea name="content" style="height: 10px;" #inputFocus id="content" maxlength="240"  [(ngModel)]="formValue" (keyup.enter)="sendMessage()" class="form-control type_msg" placeholder="Nhập nội dung..."></textarea>
                <!-- <div class="emojbox">
                    <div id="emoji" #emojiView data-emoji-placeholder=":smiley:"></div>
                </div> -->
                <div class="input-group-append">
                    <span class="input-group-text send_btn" id="btnSendd" (click)="sendMessage()"><i class="fas fa-paper-plane"></i></span>
                </div>
            </div>
        </div>
    </div>
    <script>
    
    </script>